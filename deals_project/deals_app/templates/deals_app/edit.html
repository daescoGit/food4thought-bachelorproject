{% extends 'base.html' %}
{% block title %}Edit post{% endblock title %}
{% block content %} 
<div class="main">
    <div class="content">
        <form id="editPostForm" class="editPostForm" method="POST" action="{% url 'deals_app:edit' post.slug %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="heading">Edit post</div>
            <div class="pairContainer">
                <div class="formPair">
                    <label>Title<span class="asterisk">*</span></label>
                    <div class="inputContainer">
                        {{form.title }}
                    </div>
                </div>
                
                <div class="formPair">
                    <label>Expiry Date</label>
                    <div class="inputContainer">
                        {{form.expiration_date}}
                    </div>
                </div>
            </div>

            <div class="pairContainer">
                <div class="formPair">
                    <label>New price<span class="asterisk">*</span></label>
                    <div class="inputContainer">
                        {{form.new_price}}
                    </div>
                </div>
                
                <div class="formPair">
                    <label>Old price<span class="asterisk">*</span></label>
                    <div class="inputContainer">
                        {{form.old_price}}
                    </div>
                </div>
            </div>
            <div class="formSingle">
                <label>Category<span class="asterisk">*</span></label>
                <div class="inputContainer">
                    {{form.category}}
                </div>
            </div>
            <div class="formSingle">
                <label>Description<span class="asterisk">*</span></label>
                <div class="inputContainer">
                    {{form.description}}
                </div>
            </div>
            <div class="formSingle">
                <label>Images<span class="asterisk">*</span></label>
                <input class="multiFiles" type="file" multiple>
        </form>
        <div>
            {{ form.errors }}
        </div>
    </div>
</div>
<div class="submitForm">
    <div id="savePost">Submit</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');
        var files = []
        FilePond.registerPlugin(FilePondPluginFileValidateSize);
        FilePond.registerPlugin(FilePondPluginFileValidateType);
        FilePond.registerPlugin(FilePondPluginImagePreview);
        FilePond.registerPlugin(FilePondPluginFileEncode);

        FilePond.setOptions({
            allowMultiple:true,
            maxFiles:10,
            maxFileSize: '3MB'
        })
        const inputElement = document.querySelector('input[type="file"]');

        let file, index;
        const pond = FilePond.create( inputElement, {
            acceptedFileTypes:['image/png', 'image/jpeg'],
            imagePreviewHeight: "50px",
            onaddfile: (err, fileItem) => {
                if(fileItem.file instanceof File){
                    if (!err) {
                        files.push(fileItem.getFileEncodeDataURL())
                        console.log(fileItem.file)
                    }
                    console.log(files)
                } else {
                    if (err) {
                        console.log(err)
                        return
                    }
                }
            },
            beforeRemoveFile: (fileItem) =>{
                console.log('fileItem is ', fileItem)
                if(fileItem.file instanceof File){

                index = files.indexOf(fileItem.getFileEncodeDataURL())
                console.log(files)
                console.log(index)
                } else {
                files.forEach((object)=>{
                    if (object.url == fileItem.file.name){
                        index = files.indexOf(object);
                    }
                })
                }
                            
                if (index > -1) {
                files.splice(index, 1)
                }
                console.log(files)  
            }
        });

        let urlarray, urlsplit, url, pk
        let obj = {} 
        {% for postImage in postImages %}
            url = "{{postImage.image.url}}"
            pk = "{{postImage.pk}}"
            urlarray = url.split("/")
            urlsplit = urlarray[urlarray.length - 1]
            obj = {"url": urlsplit, "pk": pk}
            console.log(obj)
            pond.addFile(url)
            files.push(obj)
            obj = {}
        {% endfor %}
        console.log(files)

    document.getElementById("savePost").addEventListener("click", ()=>{
        let form = document.forms["editPostForm"]
        let formData = new FormData()
        let formDataFiles = new FormData()
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')
        let length = 0, existingLength = 0;
        for (var i = 0; i < files.length; i++) {
            if (files[i].url){
                /*  FILE ALREADY SUBMITTED */ 
                formData.append('existingImages' + existingLength, files[i].pk)
                existingLength ++
            } 
            else {
                /* NEW FILE */ 
                formData.append('newImages' + length, files[i])
                length ++
            }
        }
        console.log(length)
        console.log(existingLength)
        formData.append('existingImagesLength', existingLength)
        formData.append('newImagesLength', length)


        document.querySelector('.filepond--browser').setAttribute("name", "test"); 

        for (var pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);

            let input = document.createElement("input");
            input.setAttribute("name", pair[0]);
            input.setAttribute("value", pair[1]);
            form.appendChild(input);
        }

        console.log(form)
        form.submit()

    }); 
})
       
    
</script>


<style>
   
.main {
    flex-direction:row!important;
    align-items:center;
}

.content {
    margin-top:4.5em;
    flex-grow: 1;
    background:white;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    color: #545454;
}

.editPostForm {
    margin:2em;
}

.submitForm {
    margin-left: 1em;
    padding: 1em;
    background: #EF7B72;
    color:white;
    font-weight:500;
}

label {
    display:flex;
    font-size:1em;
}

.formPair {
    display:flex;
    flex-direction:column;
    width:45%;
    margin-top: 1em;
}

.formSingle {
    margin-top:1em;
}

.heading {
    font-size:1.5em;
    color: #EF7B72;
}

.content .asterisk {
    color: #EF7B72;
}

label {
    margin:.5em 0;
}

.pairContainer {
    display:flex;
    flex-direction:row;
    width:100%;
    justify-content:space-between;
}

.inputContainer {
    display:flex;
    border:1px solid #dadada;
    box-shadow: 0px 1px 5px 0px #DCDDDC;
    padding:.5em;
    border-radius:1em;
}

.inputContainer i {
    color: #dadada;
    margin-right:.5em;
    display:flex;
}

.inputContainer input, .inputContainer textarea {
    border: none;
    font-weight:500;
    color: #555454;
    flex:1;
}

.inputContainer textarea {
    height:20em;
}

.multiFiles {
    margin-top:1em;
}


/* FILEPOND */

.filepond--image-clip {
    height:50%;
    margin:0;
    margin-left:auto;
}

.filepond--image-preview-overlay-idle {
    opacity:0;
    color:transparent;
}


</style>
{% endblock content %}